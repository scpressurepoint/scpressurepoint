<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Estimate Generator</title>
    <style>
   * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: white;
            color: black;
            padding: 20px;
            line-height: 1.4;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 500px 1fr;
            gap: 40px;
        }
        
        .input-section {
            border: 1px solid black;
            padding: 20px;
        }
        
        .input-section h2 {
            border-bottom: 2px solid black;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 18px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid black;
            font-size: 14px;
            font-family: Arial, sans-serif;
        }
        
        .form-group textarea {
            resize: vertical;
            height: 60px;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: 2px solid black;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .service-item {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 15px;
            background: #f9f9f9;
        }
        
        .service-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .service-header h4 {
            margin: 0;
        }
        
        .remove-service {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .remove-service:hover {
            background: #c82333;
        }
        
        .add-service-btn {
            width: 100%;
            background: #28a745;
            color: white;
            border: none;
            padding: 10px;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 15px;
        }
        
        .add-service-btn:hover {
            background: #218838;
        }
        
        .calc-button {
            width: 100%;
            background: black;
            color: white;
            border: none;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .calc-button:hover {
            background: #333;
        }
        
        .section-header {
            background: #f0f0f0;
            padding: 8px;
            margin: 15px -20px 15px -20px;
            border-left: 4px solid black;
            font-weight: bold;
            font-size: 14px;
        }
        
        .dirt-level-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            padding: 5px;
            background: #f8f9fa;
            border-left: 3px solid #28a745;
        }
        
        .results-section {
            border: 1px solid black;
            min-height: 500px;
        }
        
        .estimate-content {
            padding: 20px;
        }
        
        .estimate-header {
            text-align: center;
            border-bottom: 2px solid black;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        
        .estimate-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .estimate-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .estimate-table th,
        .estimate-table td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        
        .estimate-table th {
            background: black;
            color: white;
            font-weight: bold;
        }
        
        .total-row {
            font-weight: bold;
            border-top: 2px solid black;
        }
        
        .subtotal-row {
            font-weight: bold;
            border-top: 1px solid black;
        }
        
        .service-group-header {
            background: #f0f0f0;
            font-weight: bold;
        }
        
        .download-btn {
            background: black;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .download-btn:hover {
            background: #333;
        }
        
        .notes-section {
            margin-top: 20px;
            border-top: 1px solid #ccc;
            padding-top: 15px;
        }
        
        @media (max-width: 1000px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
        
        @media print {
            .input-section {
                display: none;
            }
            .container {
                grid-template-columns: 1fr;
            }
            .download-btn {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="input-section">
            <h2>ADVANCED ESTIMATE GENERATOR</h2>
            
            <form id="estimateForm">
                <div class="section-header">CUSTOMER INFORMATION</div>
                
                <div class="form-group">
                    <label for="customerName">Customer Name:</label>
                    <input type="text" id="customerName" placeholder="Enter customer name" required>
                </div>
                
                <div class="form-group">
                    <label for="customerAddress">Customer Address (Optional):</label>
                    <textarea id="customerAddress" placeholder="Enter customer address"></textarea>
                </div>
                
                <div class="section-header">PRICING & MATERIALS</div>
                
                <div class="two-column">
                    <div class="form-group">
                        <label for="gasCost">Gas Price ($/gal):</label>
                        <input type="number" id="gasCost" step="0.01" value="3.50" required>
                    </div>

                </div>
                
                <div class="form-group">
                    <label for="chemicalName">Chemical Name:</label>
                    <input type="text" id="chemicalName" value="Krud Kutter" required>
                </div>
                
                <div class="two-column">
                    <div class="form-group">
                        <label for="chemicalCost">Chemical Price ($/gal):</label>
                        <input type="number" id="chemicalCost" step="0.01" value="15.00" required>
                    </div>
                </div>
                
                <div class="section-header">SERVICES</div>
                
                <div id="servicesContainer">
                    <div class="service-item" data-service-id="1">
                        <div class="service-header">
                            <h4>Service 1</h4>
                            <button type="button" class="remove-service" onclick="removeService(1)" style="display: none;">Remove</button>
                        </div>
                        
                        <div class="form-group">
                            <label>Property/Area Description:</label>
                            <input type="text" name="description" placeholder="e.g. Main House, Driveway, Pool Deck" required>
                        </div>
                        
                        <div class="two-column">
                            <div class="form-group">
                                <label>Square Footage:</label>
                                <input type="number" name="squareFootage" placeholder="Enter sq ft" required>
                            </div>
                            <div class="form-group">
                                <label>Price per Sq Ft ($):</label>
                                <input type="number" name="pricePerSqFt" step="0.01" placeholder="0.30" value="0.30" required>
                            </div>
                        </div>
                        
                        <div class="two-column">
                            <div class="form-group">
                                <label>Number of Workers:</label>
                                <select name="numWorkers" required>
                                    <option value="1">1 Worker</option>
                                    <option value="2">2 Workers</option>
                                </select>
                            </div>
                        <div class="form-group">
                            <label>Dirt Level:</label>
                            <div style="margin: 10px 0;">
                                <input type="range" name="dirtLevel" min="1" max="5" step="0.1" value="3.5" 
                                       style="width: 100%;" oninput="updateDirtDisplay(this)">
                                <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-top: 5px;">
                                    <span>Light Work</span>
                                    <span>Heavy Work</span>
                                </div>
                                <div style="text-align: center; margin-top: 5px;">
                                    <span name="dirtDisplay" style="font-weight: bold; color: #333;">Level 3.5</span>
                                </div>
                            </div>
                        </div>
                        </div>
                        
                        <div class="dirt-level-info">
                            <strong>Dirt Level Guide:</strong><br>
                            Level 1: Maintenance cleaning, minimal buildup<br>
                            Level 2: Light cleaning, some dust/dirt<br>
                            Level 3: Normal residential cleaning<br>
                            Level 3.5: Heavy buildup, typical baseline (2000 sq ft ≈ 10 hours)<br>
                            Level 4: Very dirty, requires extra time<br>
                            Level 5: Extreme conditions, maximum time needed
                        </div>
                    </div>
                </div>
                
                <button type="button" class="add-service-btn" onclick="addService()">+ Add Another Service</button>
                
                <div class="section-header">OVERALL ADJUSTMENTS</div>
                
                <div class="two-column">
                    <div class="form-group">
                        <label for="discount">Overall Discount (%):</label>
                        <input type="number" id="discount" step="1" placeholder="0" min="0" max="100" value="0">
                    </div>
                    <div class="form-group">
                        <label for="additionalCost">Additional Cost ($):</label>
                        <input type="number" id="additionalCost" step="0.01" placeholder="0" min="0" value="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="discountReason">Discount Reason:</label>
                    <input type="text" id="discountReason" placeholder="e.g. Loyal Customer Discount">
                </div>
                
                <div class="form-group">
                    <label for="additionalReason">Additional Cost Reason:</label>
                    <input type="text" id="additionalReason" placeholder="e.g. Travel fee, Special equipment">
                </div>
                
                <div class="form-group">
                    <label for="notes">Notes (Optional):</label>
                    <textarea id="notes" placeholder="Any additional notes or terms"></textarea>
                </div>
                
                <button type="button" class="calc-button" onclick="generateEstimate()">
                    GENERATE ESTIMATE
                </button>
                
                <div class="section-header" style="margin-top: 20px;">SAVE & LOAD</div>
                
                <div class="two-column">
                    <button type="button" class="add-service-btn" onclick="saveEstimate()" style="margin-bottom: 5px;">
                        💾 Save Estimate
                    </button>
                    <button type="button" class="add-service-btn" onclick="document.getElementById('loadFile').click()" style="margin-bottom: 5px;">
                        📁 Load Estimate
                    </button>
                </div>
                
                <input type="file" id="loadFile" accept=".json" style="display: none;" onchange="loadEstimate(event)">
                
                <div class="form-group" style="margin-bottom: 5px;">
                    <label for="estimateName">Estimate Name (for saving):</label>
                    <input type="text" id="estimateName" placeholder="Enter name for this estimate">
                </div>
            </form>
        </div>
        
        <div class="results-section">
            <div class="estimate-content" id="estimateContent">
                <p style="text-align: center; color: #666; margin: 50px 0;">
                    Fill out the form to generate estimate
                </p>
            </div>
        </div>
    </div>

    <script>
        let serviceCounter = 1;
        
        function addService() {
            serviceCounter++;
            const container = document.getElementById('servicesContainer');
            
            const serviceDiv = document.createElement('div');
            serviceDiv.className = 'service-item';
            serviceDiv.setAttribute('data-service-id', serviceCounter);
            
            serviceDiv.innerHTML = `
                <div class="service-header">
                    <h4>Service ${serviceCounter}</h4>
                    <button type="button" class="remove-service" onclick="removeService(${serviceCounter})">Remove</button>
                </div>
                
                <div class="form-group">
                    <label>Property/Area Description:</label>
                    <input type="text" name="description" placeholder="e.g. Main House, Driveway, Pool Deck" required>
                </div>
                
                <div class="two-column">
                    <div class="form-group">
                        <label>Square Footage:</label>
                        <input type="number" name="squareFootage" placeholder="Enter sq ft" required>
                    </div>
                    <div class="form-group">
                        <label>Price per Sq Ft ($):</label>
                        <input type="number" name="pricePerSqFt" step="0.01" placeholder="0.30" value="0.30" required>
                    </div>
                </div>
                
                <div class="two-column">
                    <div class="form-group">
                        <label>Number of Workers:</label>
                        <select name="numWorkers" required>
                            <option value="1">1 Worker</option>
                            <option value="2">2 Workers</option>
                        </select>
                    </div>
                        <div class="form-group">
                            <label>Dirt Level:</label>
                            <div style="margin: 10px 0;">
                                <input type="range" name="dirtLevel" min="1" max="5" step="0.1" value="3.5" 
                                       style="width: 100%;" oninput="updateDirtDisplay(this)">
                                <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-top: 5px;">
                                    <span>Light Work</span>
                                    <span>Heavy Work</span>
                                </div>
                                <div style="text-align: center; margin-top: 5px;">
                                    <span name="dirtDisplay" style="font-weight: bold; color: #333;">Level 3.5</span>
                                </div>
                            </div>
                        </div>
                </div>
                
                <div class="dirt-level-info">
                    <strong>Dirt Level Guide:</strong><br>
                    Level 1: Maintenance cleaning, minimal buildup<br>
                    Level 2: Light cleaning, some dust/dirt<br>
                    Level 3: Normal residential cleaning<br>
                    Level 3.5: Heavy buildup, typical baseline (2000 sq ft ≈ 10 hours)<br>
                    Level 4: Very dirty, requires extra time<br>
                    Level 5: Extreme conditions, maximum time needed
                </div>
            `;
            
            container.appendChild(serviceDiv);
            updateRemoveButtons();
        }
        
        function removeService(serviceId) {
            const serviceItem = document.querySelector(`[data-service-id="${serviceId}"]`);
            serviceItem.remove();
            updateRemoveButtons();
        }
        
        function updateRemoveButtons() {
            const services = document.querySelectorAll('.service-item');
            services.forEach((service, index) => {
                const removeBtn = service.querySelector('.remove-service');
                if (services.length > 1) {
                    removeBtn.style.display = 'inline-block';
                } else {
                    removeBtn.style.display = 'none';
                }
            });
        }
        
        function updateDirtDisplay(slider) {
            const value = parseFloat(slider.value);
            const display = slider.parentNode.querySelector('[name="dirtDisplay"]');
            display.textContent = `Level ${value.toFixed(1)}`;
        }
        
        function calculateTimeFromDirtLevel(squareFootage, dirtLevel, numWorkers) {
            // Baseline: 2000 sq ft at dirt level 3.5 = 10 hours with 1 worker
            const baseSquareFootage = 2000;
            const baseDirtLevel = 3.5;
            const baseHours = 10;
            
            // Calculate time multipliers
            const squareFootageRatio = squareFootage / baseSquareFootage;
            
            // Dirt level multiplier (exponential scaling)
            let dirtMultiplier;
            if (dirtLevel <= 1) {
                dirtMultiplier = 0.5; // Level 1: 50% of baseline time
            } else if (dirtLevel <= 2) {
                dirtMultiplier = 0.7; // Level 2: 70% of baseline time
            } else if (dirtLevel <= 3) {
                dirtMultiplier = 0.85; // Level 3: 85% of baseline time
            } else if (dirtLevel <= 3.5) {
                dirtMultiplier = 1.0; // Level 3.5: 100% baseline
            } else if (dirtLevel <= 4) {
                dirtMultiplier = 1.25; // Level 4: 125% of baseline time
            } else {
                dirtMultiplier = 1.6; // Level 5: 160% of baseline time
            }
            
            // Calculate base time for 1 worker
            let estimatedHours = baseHours * squareFootageRatio * dirtMultiplier;
            
            // Adjust for multiple workers (efficiency factor)
            if (numWorkers === 2) {
                estimatedHours = estimatedHours * 0.6; // 2 workers are 60% as efficient per person but total faster
            }
            
            return estimatedHours;
        }
        
        function generateEstimate() {
            // Get pricing and materials info
            const gasCost = parseFloat(document.getElementById('gasCost').value);
            const chemicalName = document.getElementById('chemicalName').value || 'Chemical';
            const chemicalCost = parseFloat(document.getElementById('chemicalCost').value);
            
            // Get customer info
            const customerName = document.getElementById('customerName').value || 'Customer';
            const customerAddress = document.getElementById('customerAddress').value;
            const discountPercent = parseFloat(document.getElementById('discount').value) || 0;
            const discountReason = document.getElementById('discountReason').value || 'Discount';
            const additionalCost = parseFloat(document.getElementById('additionalCost').value) || 0;
            const additionalReason = document.getElementById('additionalReason').value || 'Additional Cost';
            const notes = document.getElementById('notes').value;
            
            // Validate inputs
            if (!customerName.trim()) {
                alert('Please enter a customer name');
                return;
            }
            
            if (!gasCost || !chemicalCost) {
                alert('Please fill in all pricing and materials information');
                return;
            }
            
            // Get all services
            const services = [];
            const serviceItems = document.querySelectorAll('.service-item');
            
            let hasValidService = false;
            serviceItems.forEach((item, index) => {
                const description = item.querySelector('[name="description"]').value;
                const squareFootage = parseFloat(item.querySelector('[name="squareFootage"]').value);
                const pricePerSqFt = parseFloat(item.querySelector('[name="pricePerSqFt"]').value);
                const numWorkers = parseInt(item.querySelector('[name="numWorkers"]').value);
                const dirtLevel = parseFloat(item.querySelector('[name="dirtLevel"]').value);
                
                if (description && squareFootage && pricePerSqFt && numWorkers && dirtLevel) {
                    services.push({
                        description,
                        squareFootage,
                        pricePerSqFt,
                        numWorkers,
                        dirtLevel
                    });
                    hasValidService = true;
                } else if (description || squareFootage || pricePerSqFt) {
                    alert(`Please complete all fields for Service ${index + 1} or remove it`);
                    return;
                }
            });
            
            if (!hasValidService) {
                alert('Please add at least one complete service');
                return;
            }
            
            // Calculate totals
            let totalPressureWashing = 0;
            let totalFuelCost = 0;
            let totalChemicalCost = 0;
            let totalEstimatedTime = 0;
            let totalSquareFootage = 0;
            let totalFuelGallons = 0;
            let totalChemical = 0;
            
            let tableRows = '';
            
            services.forEach((service, index) => {
                // Calculate time based on dirt level
                const estimatedHours = calculateTimeFromDirtLevel(
                    service.squareFootage, 
                    service.dirtLevel, 
                    service.numWorkers
                );
                
                // Calculate chemical usage (0.3 gal per 1000 sq ft)
                const estimatedChemical = (service.squareFootage / 1000) * 0.3;
                
                // Calculate fuel usage
                const fuelRatePerHour = 0.675; // gallons per hour per machine
                const serviceFuelGallons = fuelRatePerHour * service.numWorkers * estimatedHours;
                
                // Calculate costs
                const serviceFuelCost = serviceFuelGallons * gasCost;
                const serviceChemicalCost = estimatedChemical * chemicalCost;
                const servicePressureWashingCost = service.squareFootage * service.pricePerSqFt;
                
                // Add to totals
                totalPressureWashing += servicePressureWashingCost;
                totalFuelCost += serviceFuelCost;
                totalChemicalCost += serviceChemicalCost;
                totalEstimatedTime += estimatedHours;
                totalSquareFootage += service.squareFootage;
                totalFuelGallons += serviceFuelGallons;
                totalChemical += estimatedChemical;
                
                // Add service group header
                if (services.length > 1) {
                    tableRows += `
                        <tr class="service-group-header">
                            <td colspan="4"><strong>${service.description} (Level ${service.dirtLevel} Dirt)</strong></td>
                        </tr>`;
                }
                
                // Add service rows
                tableRows += `
                    <tr>
                        <td>${services.length > 1 ? '  ' : ''}Pressure Washing${services.length > 1 ? ' - ' + service.description : ''}</td>
                        <td>${service.squareFootage.toLocaleString()} sq ft</td>
                        <td>${service.pricePerSqFt.toFixed(2)}/sq ft</td>
                        <td>${servicePressureWashingCost.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>${services.length > 1 ? '  ' : ''}Gas Fee (${service.numWorkers} machine${service.numWorkers > 1 ? 's' : ''})</td>
                        <td>${serviceFuelGallons.toFixed(1)} gal</td>
                        <td>${gasCost.toFixed(2)}/gal</td>
                        <td>${serviceFuelCost.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td>${services.length > 1 ? '  ' : ''}${chemicalName}</td>
                        <td>${estimatedChemical.toFixed(2)} gal</td>
                        <td>${chemicalCost.toFixed(2)}/gal</td>
                        <td>${serviceChemicalCost.toFixed(2)}</td>
                    </tr>`;
            });
            
            // Calculate final totals
            const subtotal = totalPressureWashing + totalFuelCost + totalChemicalCost + additionalCost;
            const discountAmount = subtotal * (discountPercent / 100);
            const totalAfterDiscount = subtotal - discountAmount;
            
            // Add additional cost row if there's an additional cost
            if (additionalCost > 0) {
                tableRows += `
                    <tr>
                        <td>${additionalReason}</td>
                        <td>1</td>
                        <td>$${additionalCost.toFixed(2)}</td>
                        <td>$${additionalCost.toFixed(2)}</td>
                    </tr>`;
            }
            
            tableRows += `
                <tr class="subtotal-row">
                    <td colspan="3"><strong>Subtotal</strong></td>
                    <td><strong>$${subtotal.toFixed(2)}</strong></td>
                </tr>`;
            
            if (discountPercent > 0) {
                tableRows += `
                    <tr>
                        <td>Discount: ${discountReason}</td>
                        <td>1</td>
                        <td>${discountPercent}% off</td>
                        <td>-$${discountAmount.toFixed(2)}</td>
                    </tr>`;
            }
            
            tableRows += `
                <tr class="total-row">
                    <td colspan="3"><strong>ESTIMATED TOTAL</strong></td>
                    <td><strong>$${totalAfterDiscount.toFixed(2)}</strong></td>
                </tr>`;
            
            // Generate estimate number and date
            const estimateNum = 'EST-' + new Date().getFullYear() + '-' + 
                              String(Math.floor(Math.random() * 1000)).padStart(3, '0');
            const today = new Date().toLocaleDateString();
            
            // Count unique number of workers needed
            const uniqueWorkers = Math.max(...services.map(s => s.numWorkers));
            
            // Generate service details text
            let serviceDetailsText = '';
            if (services.length > 1) {
                serviceDetailsText = `Multiple Services (${services.length}):<br>`;
                services.forEach(service => {
                    serviceDetailsText += `• ${service.description}: ${service.squareFootage.toLocaleString()} sq ft (Level ${service.dirtLevel})<br>`;
                });
            } else {
                const service = services[0];
                serviceDetailsText = `Pressure Washing<br>Area: ${totalSquareFootage.toLocaleString()} sq ft<br>Dirt Level: ${service.dirtLevel}<br>`;
            }
            
            // Generate complete estimate HTML
            const estimateHTML = `
                <div class="estimate-header">
                    <h1>ESTIMATE</h1>
                    <p>Estimate #: ${estimateNum}</p>
                    <p>Date: ${today}</p>
                </div>
                
                <div class="estimate-details">
                    <div>
                        <h3>ESTIMATE FOR:</h3>
                        <p><strong>${customerName}</strong></p>
                        ${customerAddress ? `<p>${customerAddress.replace(/\n/g, '<br>')}</p>` : ''}
                    </div>
                    <div>
                        <h3>SERVICE DETAILS:</h3>
                        <p>${serviceDetailsText}</p>
                        <p>Total Area: ${totalSquareFootage.toLocaleString()} sq ft</p>
                        <p>Estimated Time: ${totalEstimatedTime.toFixed(1)} hours</p>
                        <p>Max Workers: ${uniqueWorkers}</p>
                        <p>Est. Gas Usage: ${totalFuelGallons.toFixed(1)} gal</p>
                        <p>Est. ${chemicalName}: ${totalChemical.toFixed(2)} gal</p>
                        ${additionalCost > 0 ? `<p>Additional: ${additionalReason}</p>` : ''}
                    </div>
                </div>
                
                <table class="estimate-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Qty</th>
                            <th>Rate</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
                
                ${notes ? `
                <div class="notes-section">
                    <h3>Notes:</h3>
                    <p>${notes.replace(/\n/g, '<br>')}</p>
                </div>
                ` : ''}
                
                <p style="margin-top: 20px; font-style: italic; color: #666;">
                    * This is an estimate. Actual costs may vary based on job conditions and dirt levels.
                </p>
                
                <button class="download-btn" onclick="window.print()">PRINT ESTIMATE</button>
            `;
            
            document.getElementById('estimateContent').innerHTML = estimateHTML;
        }
        
        // Initialize
        updateRemoveButtons();
        
        // Save and Load Functions
        function saveEstimate() {
            const estimateName = document.getElementById('estimateName').value || 'Unnamed_Estimate';
            
            // Collect all form data
            const estimateData = {
                version: '1.0',
                savedDate: new Date().toISOString(),
                estimateName: estimateName,
                customerInfo: {
                    name: document.getElementById('customerName').value,
                    address: document.getElementById('customerAddress').value
                },
                pricing: {
                    gasCost: document.getElementById('gasCost').value,
                    chemicalName: document.getElementById('chemicalName').value,
                    chemicalCost: document.getElementById('chemicalCost').value
                },
                services: [],
                adjustments: {
                    discount: document.getElementById('discount').value,
                    discountReason: document.getElementById('discountReason').value,
                    additionalCost: document.getElementById('additionalCost').value,
                    additionalReason: document.getElementById('additionalReason').value,
                    notes: document.getElementById('notes').value
                }
            };
            
            // Collect all services
            const serviceItems = document.querySelectorAll('.service-item');
            serviceItems.forEach((item) => {
                const service = {
                    description: item.querySelector('[name="description"]').value,
                    squareFootage: item.querySelector('[name="squareFootage"]').value,
                    pricePerSqFt: item.querySelector('[name="pricePerSqFt"]').value,
                    numWorkers: item.querySelector('[name="numWorkers"]').value,
                    dirtLevel: item.querySelector('[name="dirtLevel"]').value
                };
                estimateData.services.push(service);
            });
            
            // Create and download file
            const dataStr = JSON.stringify(estimateData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `${estimateName.replace(/[^a-z0-9]/gi, '_')}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`Estimate "${estimateName}" saved successfully!`);
        }
        
        function loadEstimate(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const estimateData = JSON.parse(e.target.result);
                    
                    // Validate the file format
                    if (!estimateData.version || !estimateData.customerInfo || !estimateData.services) {
                        alert('Invalid estimate file format');
                        return;
                    }
                    
                    // Load customer info
                    document.getElementById('customerName').value = estimateData.customerInfo.name || '';
                    document.getElementById('customerAddress').value = estimateData.customerInfo.address || '';
                    
                    // Load pricing
                    if (estimateData.pricing) {
                        document.getElementById('gasCost').value = estimateData.pricing.gasCost || '3.50';
                        document.getElementById('chemicalName').value = estimateData.pricing.chemicalName || 'Krud Kutter';
                        document.getElementById('chemicalCost').value = estimateData.pricing.chemicalCost || '15.00';
                    }
                    
                    // Load adjustments
                    if (estimateData.adjustments) {
                        document.getElementById('discount').value = estimateData.adjustments.discount || '0';
                        document.getElementById('discountReason').value = estimateData.adjustments.discountReason || '';
                        document.getElementById('additionalCost').value = estimateData.adjustments.additionalCost || '0';
                        document.getElementById('additionalReason').value = estimateData.adjustments.additionalReason || '';
                        document.getElementById('notes').value = estimateData.adjustments.notes || '';
                    }
                    
                    // Load estimate name
                    document.getElementById('estimateName').value = estimateData.estimateName || '';
                    
                    // Clear existing services
                    const container = document.getElementById('servicesContainer');
                    container.innerHTML = '';
                    serviceCounter = 0;
                    
                    // Load services
                    estimateData.services.forEach((serviceData, index) => {
                        serviceCounter++;
                        
                        const serviceDiv = document.createElement('div');
                        serviceDiv.className = 'service-item';
                        serviceDiv.setAttribute('data-service-id', serviceCounter);
                        
                        serviceDiv.innerHTML = `
                            <div class="service-header">
                                <h4>Service ${serviceCounter}</h4>
                                <button type="button" class="remove-service" onclick="removeService(${serviceCounter})">Remove</button>
                            </div>
                            
                            <div class="form-group">
                                <label>Property/Area Description:</label>
                                <input type="text" name="description" placeholder="e.g. Main House, Driveway, Pool Deck" value="${serviceData.description || ''}" required>
                            </div>
                            
                            <div class="two-column">
                                <div class="form-group">
                                    <label>Square Footage:</label>
                                    <input type="number" name="squareFootage" placeholder="Enter sq ft" value="${serviceData.squareFootage || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label>Price per Sq Ft ($):</label>
                                    <input type="number" name="pricePerSqFt" step="0.01" placeholder="0.30" value="${serviceData.pricePerSqFt || '0.30'}" required>
                                </div>
                            </div>
                            
                            <div class="two-column">
                                <div class="form-group">
                                    <label>Number of Workers:</label>
                                    <select name="numWorkers" required>
                                        <option value="1" ${serviceData.numWorkers === '1' ? 'selected' : ''}>1 Worker</option>
                                        <option value="2" ${serviceData.numWorkers === '2' ? 'selected' : ''}>2 Workers</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Dirt Level:</label>
                                    <div style="margin: 10px 0;">
                                        <input type="range" name="dirtLevel" min="1" max="5" step="0.1" value="${serviceData.dirtLevel || '3.5'}" 
                                               style="width: 100%;" oninput="updateDirtDisplay(this)">
                                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #666; margin-top: 5px;">
                                            <span>Light Work</span>
                                            <span>Heavy Work</span>
                                        </div>
                                        <div style="text-align: center; margin-top: 5px;">
                                            <span name="dirtDisplay" style="font-weight: bold; color: #333;">Level ${serviceData.dirtLevel || '3.5'}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="dirt-level-info">
                                <strong>Dirt Level Guide:</strong><br>
                                Level 1: Maintenance cleaning, minimal buildup<br>
                                Level 2: Light cleaning, some dust/dirt<br>
                                Level 3: Normal residential cleaning<br>
                                Level 3.5: Heavy buildup, typical baseline (2000 sq ft ≈ 10 hours)<br>
                                Level 4: Very dirty, requires extra time<br>
                                Level 5: Extreme conditions, maximum time needed
                            </div>
                        `;
                        
                        container.appendChild(serviceDiv);
                    });
                    
                    // Update remove buttons
                    updateRemoveButtons();
                    
                    // Clear the file input
                    event.target.value = '';
                    
                    alert(`Estimate "${estimateData.estimateName || 'Unnamed'}" loaded successfully!\nSaved on: ${new Date(estimateData.savedDate).toLocaleString()}`);
                    
                } catch (error) {
                    alert('Error loading estimate file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
    </script>
</body>
</html>
